<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simulador PPR Individual</title>

  <style>
    :root{
      --bg:#0f0f10;
      --panel:#17181b;
      --panel2:#1f2024;
      --text:#f5f6f7;
      --muted:#b8bcc6;
      --red:#e60012;
      --shadow: 0 10px 24px rgba(0,0,0,.35);
      --radius: 16px;
    }
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background: radial-gradient(1200px 700px at 20% 0%, rgba(230,0,18,.20), transparent 55%),
                  radial-gradient(900px 600px at 100% 20%, rgba(230,0,18,.10), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:24px;}
    header{display:flex;justify-content:space-between;align-items:center;gap:16px;margin-bottom:18px;}
    .brand{display:flex;flex-direction:column;gap:6px;}
    .brand h1{margin:0;font-size:18px;letter-spacing:.5px;}
    .brand span{color:var(--muted);font-size:13px;}
    .pill{background:rgba(230,0,18,.15);border:1px solid rgba(230,0,18,.35);padding:8px 12px;border-radius:999px;font-size:12px;color:var(--text);}

    .hero{
      background: linear-gradient(135deg, rgba(230,0,18,.22), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:18px;
      margin-bottom:18px;
      display:flex;
      flex-wrap:wrap;
      justify-content:space-between;
      align-items:center;
      gap:14px;
    }
    .hero .label{color:var(--muted);font-size:12px;margin-bottom:6px;}
    .hero .value{font-size:44px;font-weight:800;letter-spacing:.5px;}
    .hero .meta{color:var(--muted);font-size:12px;line-height:1.4;}
    .actions{display:flex;gap:10px;flex-wrap:wrap;}
    button{
      cursor:pointer;border:none;border-radius:12px;padding:10px 12px;
      background: var(--panel2); color: var(--text);
      border:1px solid rgba(255,255,255,.10);
      display:inline-flex; align-items:center; gap:8px;
    }
    button.primary{
      background: var(--red);
      border-color: rgba(230,0,18,.7);
      font-weight:700;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    @media (max-width:900px){ .grid{grid-template-columns:1fr;} .hero .value{font-size:38px;} }

    .card{
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      padding:16px;
      box-shadow: var(--shadow);
    }
    .card h2{margin:0 0 12px 0;font-size:14px;color:var(--muted);letter-spacing:.4px;text-transform:uppercase;}
    .fields{display:grid;grid-template-columns: 1fr 1fr;gap:12px;}
    @media (max-width:520px){ .fields{grid-template-columns:1fr;} }

    label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px;}
    input{
      width:100%; box-sizing:border-box;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      color: var(--text);
      font-weight:700;
      outline:none;
    }

    /* Intervalo por nota - melhor posicionado */
    .rangeCard{
      margin-top:12px;
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      padding:12px;
      color:var(--text);
    }
    .rangeCard b{display:block;font-size:11px;color:var(--muted);margin-bottom:6px;}
    .rangeCard .rangeLine{font-size:13px;font-weight:700;}
    .rangeCard .rangeHint{font-size:12px;color:var(--muted);margin-top:6px;line-height:1.35;}

    .error{
      display:none;
      margin-top:10px;
      background: rgba(230,0,18,.15);
      border:1px solid rgba(230,0,18,.35);
      padding:10px 12px;
      border-radius:12px;
      color:var(--text);
      font-size:12px;
    }

    details{margin-top:12px;}
    details summary{cursor:pointer;color:var(--text);font-weight:700;}
    .memory{margin-top:12px;color:var(--muted);font-size:12px;line-height:1.45;}
    .row{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;}
    .box{
      min-width:140px;
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      padding:10px;
      color:var(--text);
    }
    .box b{display:block;font-size:11px;color:var(--muted);margin-bottom:6px;}
    footer{margin-top:18px;color:var(--muted);font-size:12px;line-height:1.5;}
    a{color:inherit;text-decoration:none}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>Simulador PPR</h1>
        <span>Individual • Atualiza em tempo real</span>
      </div>
      <div class="pill">Coca-Cola FEMSA • Uso interno</div>
    </header>

    <!-- HERO: valor principal -->
    <section class="hero" aria-label="Resultado principal">
      <div>
        <div class="label">Seu PPR estimado</div>
        <div class="value" id="ppr_total">R$ 0</div>
        <div class="meta" id="hero_meta">
          Base: Salário Dez/24 • Meses • Nota • Fator
        </div>
      </div>

      <div class="actions">
        <button id="btnHome" title="Voltar para o início">
          <!-- ícone home (SVG inline, sem dependências) -->
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M3 10.5L12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-7H9v7H4a1 1 0 0 1-1-1v-10.5Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
          </svg>
          Home
        </button>

        <button class="primary" id="btnCopy">Copiar valor</button>
        <button id="btnReset">Resetar</button>
      </div>
    </section>

    <div class="grid">
      <!-- ENTRADAS -->
      <section class="card">
        <h2>Dados para simulação</h2>

        <div class="fields">
          <div>
            <label for="salario">Salário (Dez/24)</label>
            <input type="text" id="salario" inputmode="decimal" placeholder="Ex.: 3.333" />
          </div>

          <div>
            <label for="meses_trabalhados">Meses trabalhados (0 a 12)</label>
            <input type="number" id="meses_trabalhados" min="0" max="12" step="1" value="" />
          </div>

          <div>
            <label for="nota_desempenho">Nota de desempenho (0 a 5)</label>
            <input type="number" id="nota_desempenho" min="0" max="5" step="1" value="" />
          </div>

          <div>
            <label for="fator_desempenho">Fator de desempenho</label>
            <input type="number" id="fator_desempenho" step="0.001" min="0" max="1.5" value="0" />
          </div>
        </div>

        <!-- Intervalo por nota (melhor UX: dinâmico) -->
        <div class="rangeCard" id="rangeCard">
          <b>Intervalo permitido do fator</b>
          <div class="rangeLine" id="rangeLine">Selecione a nota para ver o intervalo.</div>
          <div class="rangeHint">
            Referência completa: 1=[0,000–0,624] 2=[0,625–0,899] 3=[0,900–1,134] 4=[1,135–1,383] 5=[1,384–1,500]
          </div>
        </div>

        <div id="erro_fator" class="error">
          Fator fora do intervalo permitido para a nota selecionada.
        </div>
      </section>

      <!-- MEMÓRIA -->
      <section class="card">
        <h2>Transparência do cálculo</h2>

        <details>
          <summary>Ver memória de cálculo</summary>

          <div class="memory">
            <div class="row">
              <div class="box"><b>Indicador Negócio</b><span id="nota_indicador_negocio">0</span></div>
              <div class="box"><b>Peso Negócio</b><span id="peso_indicador_negocio">0.30</span></div>
              <div class="box"><b>Resultado Negócio</b><span id="resultado_negocio">0</span></div>
            </div>

            <div class="row">
              <div class="box"><b>Fator Desempenho</b><span id="fator_desempenho_individual">0</span></div>
              <div class="box"><b>Peso Individual</b><span id="peso_indicador_individual">0.70</span></div>
              <div class="box"><b>Resultado Individual</b><span id="resultado_individual">0</span></div>
            </div>

            <div class="row">
              <div class="box"><b>Target</b><span id="target_individual">1.00</span></div>
              <div class="box"><b>Salário</b><span id="salario_individual">0</span></div>
              <div class="box"><b>Meses/12</b><span id="proporcao_mes_individual">0</span></div>
            </div>
          </div>
        </details>

        <footer>
          <b>Considerações:</b><br/>
          Simulação — valores podem variar por IR e regras sindicais. Use salário de Dezembro como base.
        </footer>
      </section>
    </div>
  </div>

  <script>
    // ===== Helpers =====
    const clamp = (n, min, max) => Math.min(max, Math.max(min, n));
    const fmtBRL0 = (n) => n.toLocaleString('pt-BR', { style:'currency', currency:'BRL', minimumFractionDigits:0, maximumFractionDigits:0 });

    function parseBRNumber(v){
      if (!v) return NaN;
      return parseFloat(
        String(v)
          .replace(/\s/g,'')
          .replace('R$','')
          .replace(/\./g,'')
          .replace(',', '.')
      );
    }

    function formatSalaryOnBlur(){
      const el = document.getElementById('salario');
      const n = parseBRNumber(el.value);
      if (!isNaN(n)) {
        // Formata com separador de milhar, sem centavos (padrão do simulador)
        el.value = n.toLocaleString('pt-BR', { minimumFractionDigits:0, maximumFractionDigits:0 });
      }
    }

    function getRangeByNota(nota){
      switch (nota) {
        case 0: return {min:0.000, max:0.000};
        case 1: return {min:0.000, max:0.624};
        case 2: return {min:0.625, max:0.899};
        case 3: return {min:0.900, max:1.134};
        case 4: return {min:1.135, max:1.383};
        case 5: return {min:1.384, max:1.500};
        default: return {min:0.000, max:1.500};
      }
    }

    // ======= Regras / Cálculo =======
    function calcular() {
      const salario = parseBRNumber(document.getElementById('salario').value);

      let mesesTrabalhados = parseInt(document.getElementById('meses_trabalhados').value, 10);
      mesesTrabalhados = clamp(isNaN(mesesTrabalhados) ? 0 : mesesTrabalhados, 0, 12); // ✅ limitador real

      const notaDesempenho = parseInt(document.getElementById('nota_desempenho').value, 10);
      const fatorDesempenho = parseFloat(document.getElementById('fator_desempenho').value);

      // Pesos fixos do Individual
      const pesoNegocio = 0.3;
      const pesoDesempenho = 0.7;
      const targetNegocio = 1.0;
      const targetIndividual = 1.0;

      // Se ainda não tiver valores mínimos, apenas zera exibição
      if (isNaN(salario) || isNaN(notaDesempenho)) {
        document.getElementById('ppr_total').textContent = "R$ 0";
        document.getElementById('hero_meta').textContent = "Base: Salário Dez/24 • Meses • Nota • Fator";
        return;
      }

      // Elegibilidade Nota 0 (mantém padrão "-")
      if (notaDesempenho === 0) {
        document.getElementById('ppr_total').textContent = "-";
        document.getElementById('hero_meta').textContent =
          `Não elegível • Meses (${mesesTrabalhados}/12)`;
        // Zera memória
        document.getElementById('nota_indicador_negocio').innerText = "0";
        document.getElementById('resultado_negocio').innerText = "0";
        document.getElementById('fator_desempenho_individual').innerText = "0";
        document.getElementById('resultado_individual').innerText = "0";
        document.getElementById('salario_individual').innerText = fmtBRL0(salario);
        document.getElementById('proporcao_mes_individual').innerText = (mesesTrabalhados/12).toFixed(2);
        return;
      }

      // ✅ trava meses no campo (se o usuário digitou 115, será ajustado)
      const mesesEl = document.getElementById('meses_trabalhados');
      if (mesesEl.value !== String(mesesTrabalhados)) mesesEl.value = String(mesesTrabalhados);

      // ✅ validação fator por faixa (não calcula se inválido)
      const {min, max} = getRangeByNota(notaDesempenho);
      const erroFator = document.getElementById('erro_fator');

      // Se nota 0, fator deve ser 0; caso contrário, valida range
      const fatorValido = (!isNaN(fatorDesempenho) && fatorDesempenho >= min && fatorDesempenho <= max);

      if (!fatorValido) {
        erroFator.style.display = 'block';
        document.getElementById('ppr_total').textContent = "R$ 0";
        document.getElementById('hero_meta').textContent =
          `Ajuste o fator (Nota ${notaDesempenho}: ${min.toFixed(3)} a ${max.toFixed(3)}) • Meses (${mesesTrabalhados}/12)`;
        return; // ✅ não calcula enquanto inválido
      } else {
        erroFator.style.display = 'none';
      }

      // Indicador de negócio atualizado (2025): 1.6261
      const notaIndicadorNegocio = 1.6261;

      const proporcaoMeses = mesesTrabalhados / 12;

      // Resultado Negócio
      const indicadorNegocio = notaIndicadorNegocio * pesoNegocio;
      const resultadoNegocio = indicadorNegocio * targetNegocio * salario * proporcaoMeses;

      // Resultado Individual
      const notaPesoIndividual = fatorDesempenho * pesoDesempenho;
      const resultadoIndividual = notaPesoIndividual * targetIndividual * salario * proporcaoMeses;

      // Base de cálculo
      const baseCalculo = resultadoNegocio + resultadoIndividual;

      // ✅ mínimo garantido (Nota 1) baseado no SALÁRIO e proporcional por meses
      const minimoGarantido = Math.max(0.60 * salario, 1059) * proporcaoMeses;

      let totalPPR;
      switch (notaDesempenho) {
        case 1:
          // Nota 1: paga pelo menos o mínimo (e garante que não fique abaixo do mínimo)
          totalPPR = Math.max(baseCalculo, minimoGarantido);
          break;
        case 2:
          totalPPR = baseCalculo * 0.75;
          break;
        default:
          totalPPR = baseCalculo * 1.00;
          break;
      }

      // Render
      document.getElementById('ppr_total').textContent = fmtBRL0(totalPPR);

      document.getElementById('hero_meta').textContent =
        `Base: Salário Dez/24 • Meses (${mesesTrabalhados}/12) • Nota ${notaDesempenho} • Fator ${fatorDesempenho.toFixed(3)}`;

      // Memória
      document.getElementById('nota_indicador_negocio').innerText = notaIndicadorNegocio.toFixed(4);
      document.getElementById('peso_indicador_negocio').innerText = pesoNegocio.toFixed(2);
      document.getElementById('resultado_negocio').innerText = fmtBRL0(resultadoNegocio);

      document.getElementById('fator_desempenho_individual').innerText = fatorDesempenho.toFixed(3);
      document.getElementById('peso_indicador_individual').innerText = pesoDesempenho.toFixed(2);
      document.getElementById('resultado_individual').innerText = fmtBRL0(resultadoIndividual);

      document.getElementById('target_individual').innerText = "1.00";
      document.getElementById('salario_individual').innerText = fmtBRL0(salario);
      document.getElementById('proporcao_mes_individual').innerText = proporcaoMeses.toFixed(2);
    }

    // Intervalo por nota - UX
    function atualizarIntervaloNotaUI(){
      const nota = parseInt(document.getElementById('nota_desempenho').value, 10);
      const {min, max} = getRangeByNota(nota);
      const rangeLine = document.getElementById('rangeLine');

      if (isNaN(nota)) {
        rangeLine.textContent = "Selecione a nota para ver o intervalo.";
        return;
      }
      if (nota === 0) {
        rangeLine.textContent = "Nota 0 → Não elegível (fator deve ser 0,000).";
        return;
      }
      rangeLine.textContent = `Nota ${nota} → fator permitido: ${min.toFixed(3)} a ${max.toFixed(3)}`;
    }

    function atualizarLimitesFator() {
      const nota = parseInt(document.getElementById('nota_desempenho').value, 10);
      const inputFator = document.getElementById('fator_desempenho');

      const {min, max} = getRangeByNota(nota);
      inputFator.min = min;
      inputFator.max = max;

      // ✅ clamp automático (se quiser “restaurar”, aqui é o lugar)
      const value = parseFloat(inputFator.value);
      if (!isNaN(value)) {
        const clamped = clamp(value, min, max);
        if (clamped !== value) inputFator.value = clamped.toFixed(3);
      }
    }

    function atualizarValores(){
      atualizarIntervaloNotaUI();
      atualizarLimitesFator();
      calcular();
    }

    // Botões
    document.getElementById('btnHome').addEventListener('click', () => {
      window.location.href = 'index.html'; // ✅ volta para a home
    });

    document.getElementById('btnCopy').addEventListener('click', async () => {
      const v = document.getElementById('ppr_total').textContent;
      try { await navigator.clipboard.writeText(v); } catch(e) {}
    });

    document.getElementById('btnReset').addEventListener('click', () => {
      document.getElementById('salario').value = "";
      document.getElementById('meses_trabalhados').value = "";
      document.getElementById('nota_desempenho').value = "";
      document.getElementById('fator_desempenho').value = "0";
      atualizarValores();
    });

    // Eventos
    ['salario','meses_trabalhados','nota_desempenho','fator_desempenho']
      .forEach(id => document.getElementById(id).addEventListener('input', atualizarValores));

    // Máscara simples do salário (no blur)
    document.getElementById('salario').addEventListener('blur', () => {
      formatSalaryOnBlur();
      atualizarValores();
    });

    window.onload = atualizarValores;
  </script>
</body>
</html>
